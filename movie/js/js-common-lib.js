(function(){window.piaolala=window.piaolala||{};piaolala.config=$.extend({basepath:"",loginback:function(){}},piaolala.config);piaolala.tab={init:function(options){var exclude=[],currentClsName="ui-tab-trigger-item-current";if(options){if(options.exclude){exclude=exclude.concat(options.exclude)}if(options.current){currentClsName=options.current}}$(".ui-tab").not(exclude.join(",")).find(".ui-tab-trigger:first").on("click",".ui-tab-trigger-item",function(){var i;i=$(this).index();$(this).addClass(currentClsName).siblings().removeClass(currentClsName);$(this).parents(".ui-tab:first").children(".ui-tab-cnt").children(".ui-tab-cnt-item").eq(i).show().siblings().hide();return false})}};piaolala.dropdown={basepath:piaolala.config?(piaolala.config.basepath||""):"",init:function(context){context=context||document;$(".ui-dropdown-header",context).click(function(){return $(this).siblings(".ui-dropdown-cnt").toggle()});$(".ui-dropdown-cnt .close",context).click(function(){return $(this).parents(".ui-dropdown-cnt").hide()});$(".ui-dropdown-cnt",context).mouseleave(function(){$(this).hide()})},start:function(context){var that=this;context=context||document;$(".ui-dropdown-header",context).mousemove(function(){return $(this).siblings(".ui-dropdown-cnt").show()});$(".ui-dropdown-header",context).click(function(){location.href=that.basepath+"/mycenter/index.do"});$(".ui-dropdown-cnt",context).mouseleave(function(){$(this).hide()})}};piaolala.vilidate={basepath:piaolala.config?(piaolala.config.basepath||""):"",emailcheck:function(email){var email_regex=/^[a-zA-Z0-9_.$*-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;if(email_regex.test(email)){return true}else{return false}},nickcheck:function(nickname){return true},mobilecheck:function(mobile){var mobile_regex=/^0{0,1}(13[0-9]|14[0-9]|15[0-9]|18[0-9])[0-9]{8}$/;if(mobile_regex.test(mobile)){return true}else{return false}},rendnocheck:function(rendno){var rendno_regex=/^[a-zA-Z0-9]{4}$/;if(rendno_regex.test(rendno)){return true}else{return false}},passcheck:function(pass){var pass_regex=/^[A-Za-z0-9]{6,16}$/;if(pass_regex.test(pass)){return true}else{return false}},islogin:function(after,opts){var that=this;$.ajax({url:that.basepath+"/user/isLogin.do",error:function(request){alert("系统忙，请稍后再试！");return false},success:function(data){after(data,opts)}})}};piaolala.win={basepath:piaolala.config?(piaolala.config.basepath||""):"",$loginDialog:"",callbake:function(){},init:function(){var that=this;$("#btn-enter").click(function(){that.quickLogin()});$("#btn-reg").click(function(){that.quickReg()});$("#userlogin input").keydown(function(event){if(event.keyCode===13){that.quickLogin()}});$("#userreg input").keydown(function(event){if(event.keyCode===13){that.quickReg()}})},alertLogreg:function(after){callbake=after||function(){};if(this.$loginDialog){this.$loginDialog.show()}else{this.$loginDialog=new Boxy("#J-login-dialog",{title:null,modal:true});load_rendno.init()}},closeLogreg:function(){if(this.$loginDialog){this.$loginDialog.hide()}},alertreg:function(after){callbake=after||function(){};if(this.$regDialog){this.$regDialog.show()}else{this.$regDialog=new Boxy("#J-reg-dialog",{title:null,modal:true});load_rendno.init()}},closereg:function(){if(this.$regDialog){this.$regDialog.hide()}},quickLogin:function(){var that=this;var $error=$("#error-login");var username=$("#username").val();var password=$("#password").val();var $emailresult=$("#emailresult");var $safecode=$("#safecoderesult");var $passwordresult=$("#passwordresult");$emailresult.html("");$safecode.html("");$passwordresult.html("");var rendno=$("#rendnologin").val();if(username===null||username===""||username==="邮箱/手机号"){$emailresult.html("<div class='wrong-w'><div class='wrong'></div><div class='wrong-color'>邮箱/手机号码不能为空</div></div>");return false}else{if(password===null||password===""){$passwordresult.html("<div class='wrong-w'><div class='wrong'></div><div class='wrong-color'>密码不能为空</div></div>");return false}else{if(rendno===null||rendno===""){$safecode.html("<font color='red'>验证码为空</font>");return false}else{$.ajax({url:that.basepath+"/user/doQuckeLogin.do",data:{username:username,password:password,rendno:rendno},type:"POST",success:function(data){if(data.state){topbar.loadtopbar(true);that.$loginDialog.hide(callbake)}else{if(data.flag=="1"){$emailresult.html("<div class='wrong-w'><div class='wrong'></div><div class='wrong-color'>用户名/密码错误</div></div>");$passwordresult.html("<div class='wrong-w'><div class='wrong'></div><div class='wrong-color'>用户名/密码错误</div></div>")}else{$safecode.html("<font color='red'>"+data.errorStr+"</font>")}load_rendno.login_refresh()}}})}}}},quickReg:function(){var that=this;var basepath=piaolala.config?(piaolala.config.basepath||""):"";var $safecodeReg=$("#safecodeReg");var $regusernameresult=$("#regusernameresult");var $passresult=$("#passresult");var regex=/^[A-Za-z0-9]{6,20}$/;passresult.innerHTML="";var regusername=$("#regusername").val();var regpass=$("#regpass").val();var regrendno=$("#regrendno").val();var repeatpass=$("#conpass").val();var $conpassresult=$("#conpassresult");var regtype,email,mobile;$regusernameresult.html("");$passresult.html("");$safecodeReg.html("");$conpassresult.html("");var term=document.getElementById("box_rule");if(!term.checked){alert("您还没有同意用户协议！");return false}if(piaolala.vilidate.emailcheck(regusername)){regtype="email";email=regusername}else{if(piaolala.vilidate.mobilecheck(regusername)){regtype="mobile";mobile=regusername}else{$regusernameresult.html("<font color='red'>邮箱/手机号格式不对</font>");$("#regusername").val("");return false}}if(regusername===null||regusername===""||regusername==="邮箱/手机号"){$regusernameresult.html("<font color='red'>邮箱/手机号不能为空</font>");return false}else{if(regpass===null||regpass===""){$passresult.html("<font color='red'>请输入密码</font>");return false}else{if(regex.test(regpass)===false){$passresult.html("<font color='red'>密码由6-20位字母数字组成</font>");return false}else{if(repeatpass===null||repeatpass===""){$conpassresult.html("<font color='red'>请确认密码</font>");return false}else{if(regpass!=repeatpass){$conpassresult.html("<font color='red'>两次输入不一致</font>");return false}else{if(regrendno===null||regrendno===""){$safecodeReg.html("<font color='red'>验证码为空</font>");return false}}}}}}if(regtype){$.ajax({url:basepath+"/user/doRegLoad.do",data:{email:email,mobile:mobile,password:regpass,rendno:regrendno},type:"POST",beforeSend:function(){},error:function(request){alert("系统忙，请稍后再试！")},success:function(data){if(data.state){topbar.loadtopbar(true);that.$regDialog.hide(callbake)}else{if(data.flag=="1"){$regusernameresult.html("<font color='red'>"+data.errorStr+"</font>")}else{$safecodeReg.html("<font color='red'>"+data.errorStr+"</font>")}load_rendno.reg_refresh()}}})}},thirdMobilePaymentlogin:function(){var url=piaolala.config.basepath+"/thirdUser/mobilePaymentLogin.do";var b=new Base64();var reURL=b.encode(top.location.href.replace(/#/,""));window.location.href=url+"?bakUrl="+reURL},thirdAlipaylogin:function(){var url=piaolala.config.basepath+"/thirdUser/alipayLogin.do";var b=new Base64();var reURL=b.encode(top.location.href.replace(/#/,""));window.location.href=url+"?bakUrl="+reURL},thirdQQlogin:function(){var url=piaolala.config.basepath+"/thirdUser/qqLogin.do";var b=new Base64();var reURL=b.encode(top.location.href.replace(/#/,""));window.location.href=url+"?bakUrl="+reURL},thirdXLlogin:function(){var url=piaolala.config.basepath+"/thirdUser/sinaLogin.do";var b=new Base64();var reURL=b.encode(top.location.href.replace(/#/,""));window.location.href=url+"?bakUrl="+reURL},thirdDBlogin:function(){var url=piaolala.config.basepath+"/thirdUser/doubanLogin.do";var b=new Base64();var reURL=b.encode(top.location.href.replace(/#/,""));window.location.href=url+"?bakUrl="+reURL},ReceiveValue:function(value){if(value!==null){history.go(0);document.execCommand("refresh");document.location=document.location;document.location.reload()}}};piaolala.rendno={basepath:piaolala.config?(piaolala.config.basepath||""):"",init:function(context){context=context||document;var that=this;if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)==6){try{document.execCommand("BackgroundImageCache",false,true)}catch(err){}}$(".safecode",context).click(function(){that.refresh(this)});$(".safecode",context).click()},refresh:function(obj){$(obj).css("background-image","url("+this.basepath+"/image.do?code="+Math.random()+")")}};var load_rendno=(function(){var basepath=piaolala.config?(piaolala.config.basepath||""):"";var login_rand_path=basepath+"/image.do?code=";var reg_rand_path=basepath+"/quickRegImage.do?code=";var login_safecode,reg_safecode;return{init:function(){login_safecode=$("#login_safecode");reg_safecode=$("#reg_safecode");login_safecode.bind("click",function(){$(this).css("background-image","url("+login_rand_path+Math.random()+")")});reg_safecode.bind("click",function(){$(this).css("background-image","url("+reg_rand_path+Math.random()+")")});$("#regrendno").bind("focus",function(){reg_safecode.css("background-image","url("+reg_rand_path+Math.random()+")");$(this).unbind("focus")});$("#rendnologin").bind("focus",function(){login_safecode.css("background-image","url("+login_rand_path+Math.random()+Math.random()+")");$(this).unbind("focus")})},login_refresh:function(){login_safecode.css("background-image","url("+login_rand_path+Math.random()+Math.random()+")")},reg_refresh:function(){reg_safecode.css("background-image","url("+reg_rand_path+Math.random()+Math.random()+")")}}})();var topbar={basepath:piaolala.config?(piaolala.config.basepath||""):"",init:function(){var that=this;piaolala.dropdown.start("#topbar");$("#J-login").click(function(){piaolala.win.alertLogreg(piaolala.config.loginback)});$("#J-reg").click(function(){piaolala.win.alertreg(piaolala.config.loginback)});$("#J-logout").click(function(){that.logout()});$("#J-city").html($("#J-topbar-data").attr("data-cityname"))},loadtopbar:function(opt){var that=this,url;if(opt){url=that.basepath+"/user/topbar.do?code="+Math.random()}else{var staticState=$("#JS-staticState");var state=staticState.attr("data-staticstate");if(state==="0"){that.init()}else{if(state==="2"){url=that.basepath+"/user/topbar.do?citycode="+staticState.attr("data-citycode")+"&code="+Math.random()}else{if(state==="1"){url=that.basepath+"/user/topbar.do?code="+Math.random()}}}}if(url){$("#topbar").html("loading...").load(url,function(){that.init()})}},logout:function(){var that=this;$("#topbar").html("loading...").load(that.basepath+"/user/logout.do?code="+Math.random(),function(){location.reload(true)})}};piaolala.search={basepath:piaolala.config?(piaolala.config.basepath||""):"",citys:function(){var city=$("#J-city");var changCity=function(citycode){var loginhref=city.attr("data-local");var type=city.attr("data-type");var url="";if(type==="1"){if(loginhref.indexOf("?")==-1){url=loginhref+"?citycode="+citycode}else{url=loginhref+"&citycode="+citycode}}else{url=loginhref+"/"+citycode+".html"}location.href=url};var $suggestionList=$("#J-city-form .suggestion-list");$("#J-city-form").submit(function(){return false});$("#J-city-form .suggestion-input").suggest({suggestUrl:this.basepath+"/search/searchcity.do",suggestion:"#J-city-form",render:function(data){if(data.length>0){$suggestionList.empty().show();for(var i=0,len=data.length;i<len;i++){$("<div/>").addClass("suggestion-item").attr("data-city-id",data[i].id).html(data[i].title).appendTo($suggestionList).click(function(){changCity($(this).attr("data-city-id"))})}}},submit:function(){var cityid=$suggestionList.children(".current").attr("data-city-id");changCity(cityid)}})},global:function(){var that=this;var $suggestionList=$("#J-global-search .suggestion-list");$("#J-global-search").submit(function(){return false});$("#J-global-search .suggestion-input").suggest({suggestUrl:this.basepath+"/search/searchGlobal.do",suggestion:"#J-global-search",render:function(data){if(data.length>0){$suggestionList.empty().show();for(var i=0,len=data.length;i<len;i++){$("<div/>").addClass("suggestion-item").attr("data-id",data[i].id).attr("data-type",data[i].type).html(data[i].title).appendTo($suggestionList).click(function(){var type=$suggestionList.children(".current").attr("data-type");var dateid=$suggestionList.children(".current").attr("data-id");if(type==="2"){location.href=that.basepath+"/movie/movieinfo/movieInfo.do?filmCode="+dateid}else{if(type==="3"){location.href=that.basepath+"/cinema/cinemainfo/cinemainfo.do?cinemaCode="+dateid}}})}}},submit:function(){var type=$suggestionList.children(".current").attr("data-type");var dateid=$suggestionList.children(".current").attr("data-id");if(type==="2"){location.href=that.basepath+"/movie/movieinfo/movieInfo.do?filmCode="+dateid}else{if(type==="3"){location.href=that.basepath+"/cinema/cinemainfo/cinemainfo.do?cinemaCode="+dateid}}}})},cinema:function(){var that=this;var $suggestionList=$("#J-cinema-form .suggestion-list");$("#J-cinema-form").submit(function(){return false});$("#J-cinema-form .suggestion-input").suggest({suggestUrl:this.basepath+"/search/searchcinema.do",suggestion:"#J-cinema-form",render:function(data){if(data.length>0){$suggestionList.empty().show();for(var i=0,len=data.length;i<len;i++){$("<div/>").addClass("suggestion-item").attr("data-id",data[i].id).attr("data-type",data[i].type).html(data[i].title).appendTo($suggestionList).click(function(){var dateid=$suggestionList.children(".current").attr("data-id");location.href=that.basepath+"/cinema/cinemainfo.do?cinemaCode="+dateid})}}},submit:function(){var dateid=$suggestionList.children(".current").attr("data-id");location.href=that.basepath+"/cinema/cinemainfo.do?cinemaCode="+dateid}})}};piaolala.util=piaolala.util?piaolala.util:{};piaolala.util={format_mobile:function(mobileno){return mobileno.replace(/\s/g,"").replace(/^(\d{3})(\d{4})(\d{4})$/,"$1 $2 $3")},unformat_mobile:function(mobileno){return mobileno.replace(/[ ]/g,"")}};$(function(){topbar.loadtopbar();piaolala.win.init();piaolala.dropdown.init(".page-header");piaolala.search.citys();piaolala.search.global()})}).call(this);function Base64(){_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.encode=function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=_utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else{if(isNaN(chr3)){enc4=64}}output=output+_keyStr.charAt(enc1)+_keyStr.charAt(enc2)+_keyStr.charAt(enc3)+_keyStr.charAt(enc4)}return output};this.decode=function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=_keyStr.indexOf(input.charAt(i++));enc2=_keyStr.indexOf(input.charAt(i++));enc3=_keyStr.indexOf(input.charAt(i++));enc4=_keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=_utf8_decode(output);return output};_utf8_encode=function(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else{if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128)}else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128)}}}return utftext};_utf8_decode=function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else{if((c>191)&&(c<224)){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode(((c&31)<<6)|(c2&63));i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode(((c&15)<<12)|((c2&63)<<6)|(c3&63));i+=3}}}return string}}jQuery.fn.boxy=function(options){options=options||{};return this.each(function(){var node=this.nodeName.toLowerCase(),self=this;if(node=="a"){jQuery(this).click(function(){var active=Boxy.linkedTo(this),href=this.getAttribute("href"),localOptions=jQuery.extend({actuator:this,title:this.title},options);if(active){active.show()}else{if(href.indexOf("#")>=0){var content=jQuery(href.substr(href.indexOf("#"))),newContent=content.clone(true);content.remove();localOptions.unloadOnHide=false;new Boxy(newContent,localOptions)}else{if(!localOptions.cache){localOptions.unloadOnHide=true}Boxy.load(this.href,localOptions)}}return false})}else{if(node=="form"){jQuery(this).bind("submit.boxy",function(){Boxy.confirm(options.message||"请确认：",function(){jQuery(self).unbind("submit.boxy").submit()});return false})}}})};function Boxy(element,options){this.boxy=jQuery(Boxy.WRAPPER);jQuery.data(this.boxy[0],"boxy",this);this.visible=false;this.options=jQuery.extend({},Boxy.DEFAULTS,options||{});if(this.options.modal){this.options=jQuery.extend(this.options,{center:true,draggable:false})}if(this.options.actuator){jQuery.data(this.options.actuator,"active.boxy",this)}this.setContent(element||"<div></div>");this._setupTitleBar();this.boxy.css("display","none").appendTo(document.body);this.toTop();if(this.options.fixed){if(jQuery.browser.msie&&jQuery.browser.version<7){this.options.fixed=false}else{this.boxy.addClass("fixed")}}if(this.options.center&&Boxy._u(this.options.x,this.options.y)){this.center()}else{this.moveTo(Boxy._u(this.options.x)?this.options.x:Boxy.DEFAULT_X,Boxy._u(this.options.y)?this.options.y:Boxy.DEFAULT_Y)}if(this.options.show){this.show()}}Boxy.EF=function(){};jQuery.extend(Boxy,{WRAPPER:"<table cellspacing='0' cellpadding='0' border='0' class='boxy-wrapper'><tr><td class='top-left'></td><td class='top'></td><td class='top-right'></td></tr><tr><td class='left'></td><td class='boxy-inner'></td><td class='right'></td></tr><tr><td class='bottom-left'></td><td class='bottom'></td><td class='bottom-right'></td></tr></table>",DEFAULTS:{title:null,closeable:true,draggable:true,clone:false,actuator:null,center:true,show:true,modal:false,fixed:true,closeText:"",unloadOnHide:false,clickToFront:false,behaviours:Boxy.EF,afterDrop:Boxy.EF,afterShow:Boxy.EF,afterHide:Boxy.EF,beforeUnload:Boxy.EF},DEFAULT_X:50,DEFAULT_Y:50,zIndex:1337,dragConfigured:false,resizeConfigured:false,dragging:null,load:function(url,options){options=options||{};var ajax={url:url,type:"GET",dataType:"html",cache:false,success:function(html){html=jQuery(html);if(options.filter){html=jQuery(options.filter,html)}new Boxy(html,options)}};jQuery.each(["type","cache"],function(){if(this in options){ajax[this]=options[this];delete options[this]}});jQuery.ajax(ajax)},get:function(ele){var p=jQuery(ele).parents(".boxy-wrapper");return p.length?jQuery.data(p[0],"boxy"):null},linkedTo:function(ele){return jQuery.data(ele,"active.boxy")},alert:function(message,callback,options){return Boxy.ask(message,["确认"],callback,options)},confirm:function(message,after,options){return Boxy.ask(message,["确认","取消"],function(response){if(response=="确认"){after()}},options)},ask:function(question,answers,callback,options){options=jQuery.extend({modal:true,closeable:false},options||{},{show:true,unloadOnHide:true});var body=jQuery("<div></div>").append(jQuery('<div class="question"></div>').html(question));var map={},answerStrings=[];if(answers instanceof Array){for(var i=0;i<answers.length;i++){map[answers[i]]=answers[i];answerStrings.push(answers[i])}}else{for(var k in answers){map[answers[k]]=k;answerStrings.push(answers[k])}}var buttons=jQuery('<form class="answers"></form>');buttons.html(jQuery.map(answerStrings,function(v){var btn_index;if(v==="确认"){btn_index=1}else{if(v==="取消"){btn_index=2}else{btn_index=3}}return"<input class='boxy-btn"+btn_index+"' type='button' value='"+v+"' />"}).join(" "));jQuery("input[type=button]",buttons).click(function(){var clicked=this;Boxy.get(this).hide(function(){if(callback){callback(map[clicked.value])}})});body.append(buttons);new Boxy(body,options)},isModalVisible:function(){return jQuery(".boxy-modal-blackout").length>0},_u:function(){for(var i=0;i<arguments.length;i++){if(typeof arguments[i]!="undefined"){return false}}return true},_handleResize:function(evt){var d=jQuery(document);jQuery(".boxy-modal-blackout").css("display","none").css({width:d.width(),height:d.height()}).css("display","block")},_handleDrag:function(evt){var d;if(d=Boxy.dragging){d[0].boxy.css({left:evt.pageX-d[1],top:evt.pageY-d[2]})}},_nextZ:function(){return Boxy.zIndex++},_viewport:function(){var d=document.documentElement,b=document.body,w=window;return jQuery.extend(jQuery.browser.msie?{left:b.scrollLeft||d.scrollLeft,top:b.scrollTop||d.scrollTop}:{left:w.pageXOffset,top:w.pageYOffset},!Boxy._u(w.innerWidth)?{width:w.innerWidth,height:w.innerHeight}:(!Boxy._u(d)&&!Boxy._u(d.clientWidth)&&d.clientWidth!=0?{width:d.clientWidth,height:d.clientHeight}:{width:b.clientWidth,height:b.clientHeight}))}});Boxy.prototype={estimateSize:function(){this.boxy.css({visibility:"hidden",display:"block"});var dims=this.getSize();this.boxy.css("display","none").css("visibility","visible");return dims},getSize:function(){return[this.boxy.width(),this.boxy.height()]},getContentSize:function(){var c=this.getContent();return[c.width(),c.height()]},getPosition:function(){var b=this.boxy[0];return[b.offsetLeft,b.offsetTop]},getCenter:function(){var p=this.getPosition();var s=this.getSize();return[Math.floor(p[0]+s[0]/2),Math.floor(p[1]+s[1]/2)]},getInner:function(){return jQuery(".boxy-inner",this.boxy)},getContent:function(){return jQuery(".boxy-content",this.boxy)},setContent:function(newContent){newContent=jQuery(newContent).css({display:"block"}).addClass("boxy-content");if(this.options.clone){newContent=newContent.clone(true)}this.getContent().remove();this.getInner().append(newContent);this._setupDefaultBehaviours(newContent);this.options.behaviours.call(this,newContent);return this},moveTo:function(x,y){this.moveToX(x).moveToY(y);return this},moveToX:function(x){if(typeof x=="number"){this.boxy.css({left:x})}else{this.centerX()}return this},moveToY:function(y){if(typeof y=="number"){this.boxy.css({top:y})}else{this.centerY()}return this},centerAt:function(x,y){var s=this[this.visible?"getSize":"estimateSize"]();if(typeof x=="number"){this.moveToX(x-s[0]/2)}if(typeof y=="number"){this.moveToY(y-s[1]/2)}return this},centerAtX:function(x){return this.centerAt(x,null)},centerAtY:function(y){return this.centerAt(null,y)},center:function(axis){var v=Boxy._viewport();var o=this.options.fixed?[0,0]:[v.left,v.top];if(!axis||axis=="x"){this.centerAt(o[0]+v.width/2,null)}if(!axis||axis=="y"){this.centerAt(null,o[1]+v.height/2)}return this},centerX:function(){return this.center("x")},centerY:function(){return this.center("y")},resize:function(width,height,after){if(!this.visible){return}var bounds=this._getBoundsForResize(width,height);this.boxy.css({left:bounds[0],top:bounds[1]});this.getContent().css({width:bounds[2],height:bounds[3]});if(after){after(this)}return this},tween:function(width,height,after){if(!this.visible){return}var bounds=this._getBoundsForResize(width,height);var self=this;this.boxy.stop().animate({left:bounds[0],top:bounds[1]});this.getContent().stop().animate({width:bounds[2],height:bounds[3]},function(){if(after){after(self)}});return this},isVisible:function(){return this.visible},show:function(){if(this.visible){return}if(this.options.modal){var self=this;if(!Boxy.resizeConfigured){Boxy.resizeConfigured=true;jQuery(window).resize(function(){Boxy._handleResize()})}this.modalBlackout=jQuery('<div class="boxy-modal-blackout"></div>').css({zIndex:Boxy._nextZ(),opacity:0.7,width:jQuery(document).width(),height:jQuery(document).height()}).appendTo(document.body);this.toTop();if(this.options.closeable){jQuery(document.body).bind("keypress.boxy",function(evt){var key=evt.which||evt.keyCode;if(key==27){self.hide();jQuery(document.body).unbind("keypress.boxy")}})}}this.boxy.stop().css({opacity:1}).show();this.visible=true;this._fire("afterShow");return this},hide:function(after){if(!this.visible){return}var self=this;if(this.options.modal){jQuery(document.body).unbind("keypress.boxy");this.modalBlackout.animate({opacity:0},function(){jQuery(this).remove()})}this.boxy.stop().animate({opacity:0},300,function(){self.boxy.css({display:"none"});self.visible=false;self._fire("afterHide");if(after){after(self)}if(self.options.unloadOnHide){self.unload()}});return this},toggle:function(){this[this.visible?"hide":"show"]();return this},hideAndUnload:function(after){this.options.unloadOnHide=true;this.hide(after);return this},unload:function(){this._fire("beforeUnload");this.boxy.remove();if(this.options.actuator){jQuery.data(this.options.actuator,"active.boxy",false)}},toTop:function(){this.boxy.css({zIndex:Boxy._nextZ()});return this},getTitle:function(){return jQuery("> .title-bar h2",this.getInner()).html()},setTitle:function(t){jQuery("> .title-bar h2",this.getInner()).html(t);return this},_getBoundsForResize:function(width,height){var csize=this.getContentSize();var delta=[width-csize[0],height-csize[1]];var p=this.getPosition();return[Math.max(p[0]-delta[0]/2,0),Math.max(p[1]-delta[1]/2,0),width,height]},_setupTitleBar:function(){if(this.options.title){var self=this;var tb=jQuery("<div class='title-bar'></div>").html("<h2>"+this.options.title+"</h2>");if(this.options.closeable){tb.append(jQuery("<a href='#' class='close'></a>").html(this.options.closeText))}if(this.options.draggable){tb[0].onselectstart=function(){return false};tb[0].unselectable="on";tb[0].style.MozUserSelect="none";if(!Boxy.dragConfigured){jQuery(document).mousemove(Boxy._handleDrag);Boxy.dragConfigured=true}tb.mousedown(function(evt){self.toTop();Boxy.dragging=[self,evt.pageX-self.boxy[0].offsetLeft,evt.pageY-self.boxy[0].offsetTop];jQuery(this).addClass("dragging")}).mouseup(function(){jQuery(this).removeClass("dragging");Boxy.dragging=null;self._fire("afterDrop")})}this.getInner().prepend(tb);this._setupDefaultBehaviours(tb)}},_setupDefaultBehaviours:function(root){var self=this;if(this.options.clickToFront){root.click(function(){self.toTop()})}jQuery(".close",root).click(function(){self.hide();return false}).mousedown(function(evt){evt.stopPropagation()})},_fire:function(event){this.options[event].call(this)}};(function($){var timeId,timer=false,preVal="",cursor=-1,KEY={ESC:27,RETURN:13,TAB:9,BS:8,DEL:46,UP:38,DOWN:40};function stopTimer(id){if(id){clearInterval(id);timer=false}}$.fn.suggest=function(opt){opt=$.extend({},{suggestUrl:"",suggestion:"#J-suggestion",timeout:500,render:function(data){},submit:function(){}},opt);var $suggestionList=$(opt.suggestion).find(".suggestion-list"),$input=$(opt.suggestion).find(".suggestion-input");$suggestionList.on("mouseover",".suggestion-item",function(){$(this).addClass("current").siblings(".current").removeClass("current")});$suggestionList.on("click",".suggestion-item",function(){$input.val($(this).text()).blur();$suggestionList.hide()}).mouseleave(function(){$input.blur();$suggestionList.hide()});return this.each(function(){$input.focus(function(){timeId=setInterval(function(){var q=$input.val();if(q!==preVal){preVal=q;$.getJSON(opt.suggestUrl,{q:q},function(data){opt.render(data)})}},opt.timeout);timer=true}).blur(function(){stopTimer(timeId);cursor=-1}).keydown(function(e){var key=e.keyCode,$suggestItems,len=0,$suggestItem;if(key===KEY.RETURN){opt.submit();$input.blur()}else{if(key===KEY.UP){if(cursor>0){$suggestItems=$suggestionList.find(".suggestion-item");stopTimer(timeId);$suggestItems.filter(".current").removeClass("current");cursor--;$suggestItem=$suggestItems.eq(cursor).addClass("current");$input.val($suggestItem.text())}}else{if(key===KEY.DOWN){$suggestItems=$suggestionList.find(".suggestion-item");len=$suggestItems.length;if(cursor<len-1){stopTimer(timeId);if(cursor!==-1){$suggestItems.filter(".current").removeClass("current")}cursor++;$suggestItem=$suggestItems.eq(cursor).addClass("current");$input.val($suggestItem.text())}}else{if(key===KEY.BS){if(!timer){$input.blur().focus()}}}}}})})}})(jQuery);window.piaolala=window.piaolala||{};piaolala.quickorder={placeholder:["选择影片","选择影城","选择场次"],filmcode:"",cinemacode:"",plancode:"",init:function(option){var that=this,isFirst=true,steps=[0,1,2];basepath=piaolala.config?(piaolala.config.basepath||""):"";option=$.extend({filmUrl:piaolala.config.basepath+"/seat/bookfilms.do",cinemaUrl:piaolala.config.basepath+"/seat/bookcinemas.do",timeUrl:piaolala.config.basepath+"/seat/bookfilmplan.do",stepDone:function(){}},option);this.$bookSeat=$("#J-book-seat");this.$stepLists=this.$bookSeat.find(".ui-dropdown-cnt").hide();this.$steps=this.$bookSeat.find(".ui-dropdown-header");this.filmUrl=option.filmUrl;this.cinemaUrl=option.cinemaUrl;this.timeUrl=option.timeUrl;this.cityId=option.cityId||"";this.stepDone=option.stepDone;this.fetch(0,this.filmUrl);this.fetch(1,this.cinemaUrl);this.enable(0).enable(1).disable(2);this.$stepLists.mouseleave(function(){$(this).hide().parents(".ui-dropdown").removeClass("current-step")}).on("mouseover click","li",function(){$(this).addClass("current").siblings(".current").removeClass("current")});this.$stepLists.eq(0).on("click","li",function(){if(isFirst){isFirst=false;steps=[0,1,2]}that.filmcode=$(this).attr("data-filmcode");var params={filmcode:that.filmcode};var secondstep=steps[1];if(secondstep===0){params.cinemacode=that.cinemacode;that.fetch(2,that.timeUrl,params);that.gostep(2)}else{if(secondstep===1){that.fetch(1,that.cinemaUrl,params);that.gostep(1)}}that.$steps.eq(0).html($(this).text())});this.$stepLists.eq(1).on("click","li",function(){if(isFirst){isFirst=false;steps=[1,0,2]}that.cinemacode=$(this).attr("data-cinemacode");var params={cinemacode:that.cinemacode};var secondstep=steps[1];if(secondstep===1){params.filmcode=that.filmcode;that.fetch(2,that.timeUrl,params);that.gostep(2)}else{if(secondstep===0){that.fetch(0,that.filmUrl,params);that.gostep(0)}}that.$steps.eq(1).html($(this).text())});this.$stepLists.eq(2).on("click","li",function(){that.plancode=$(this).attr("data-plancode");var params={filmcode:that.filmcode,cinemacode:that.cinemacode,plancode:that.plancode};that.$steps.eq(2).html($(this).text());that.stepDone(params);that.$stepLists.eq(2).hide()});return this},fetch:function(step,url,params){var $ul=$("<ul/>").html("<li>Loading...</li>"),$stepList=this.$stepLists.eq(step).empty().append($ul);$.getJSON(url,params,function(data){var $item,renderItem;if(step===0){renderItem=function(film){var $li,filmcode,filmname;filmcode=film.filmcode;filmname=film.filmname;$li=$("<li/>").attr("data-filmcode",filmcode).html(filmname);return $li}}else{if(step===1){renderItem=function(cinema){var $li,cinemacode,cinemaname;cinemacode=cinema.cinemacode;cinemaname=cinema.cinemaname;$li=$("<li/>").attr("data-cinemacode",cinemacode).html(cinemaname);return $li}}else{if(step===2){renderItem=function(time){var $li,price=time.price+"元",plantime=time.planname,hall=time.hallname,plancode=time.plancode,filmTypeName=time.filmTypeName,text=[plantime,hall,price,filmTypeName].join(" ");$li=$("<li/>").attr("data-plancode",plancode).html(text);return $li}}}}$ul.empty();for(var i=0,len=data.length;i<len;i++){$item=renderItem(data[i]);$ul.append($item)}})},gostep:function(i){this.enable(i);this.$steps.eq(i).click();for(var x=i,len=this.placeholder.length;x<len;x++){this.$steps.eq(x).text(this.placeholder[x])}if(i===2){this.$steps.eq(i).attr({"data-related-filmcode":this.filmcode,"data-related-cinemacode":this.cinemacode})}},disable:function(step){this.$steps.eq(step).addClass("step-disabled").unbind("click");return this},enable:function(step){var $step=this.$steps.eq(step).unbind("click");var that=this;$step.removeClass("step-disabled").click(function(){var $list=$(this).next();that.$stepLists.not($list).hide();$list.toggle();var $cnt=$(this).siblings(".ui-dropdown-cnt"),$drop=$(this).parents(".ui-dropdown");if($cnt.is(":visible")){that.$bookSeat.find(".current-step").removeClass("current-step");$drop.addClass("current-step")}else{$drop.removeClass("current-step")}});if(step===2){$step.click(function(){var relatedFilmCode=$(this).attr("data-related-filmcode"),relatedCinemaCode=$(this).attr("data-related-cinemacode"),params={filmcode:that.filmcode||relatedFilmCode,cinemacode:that.cinemacode||relatedCinemaCode};if(params.filmcode!==relatedFilmCode||params.cinemacode!==relatedCinemaCode){that.fetch(2,that.timeUrl,params)}})}return this}};